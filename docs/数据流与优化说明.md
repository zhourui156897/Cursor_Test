# 第二大脑：数据流说明与优化清单

## 一、日历和待办事项如何影响已有数据库

### 1. 同步方向（Apple → 第二大脑）

| 步骤 | 说明 |
|------|------|
| 1. 你点击「同步」备忘录/待办/日历 | 后端用 JXA 从 Mac 上的 App 读取数据 |
| 2. 每条变成「实体」 | 写入 SQLite `entities` 表，带 `source=apple_notes` / `apple_reminders` / `apple_calendar` |
| 3. 写入 Obsidian | 在 Vault 里生成对应 .md 笔记（如 `Resources/Apple Notes/xxx.md`） |
| 4. LLM 打标签建议 | 根据内容推荐文件夹标签、内容标签、状态，写入 `review_queue` |
| 5. 你审核 | 在「审核队列」通过/拒绝/改标签后，标签写回实体和 Obsidian frontmatter，并可入向量/图谱 |

所以：**同步 = 把苹果三件套里的条目「导入」到第二大脑**，每条在数据库里是一条实体，在 Obsidian 里是一篇笔记，之后可被搜索、打标签、进知识图谱。

### 2. Agent 创建（第二大脑 → Apple）

| 操作 | 说明 |
|------|------|
| 你让 Agent「创建一条明天 9 点的日历」 | Agent 调用 `create_apple_event`，通过 JXA 在系统「日历」里真正创建 |
| 当前行为 | **只写入 Apple 日历**，不会自动在数据库里新增实体 |
| 优化后（可选） | Agent 创建成功后，可同时在本系统里创建一条 `source=agent_apple_calendar` 的实体，便于统一检索、打标签 |

同理：`create_apple_note` / `create_apple_reminder` 目前也只写苹果端；可选「同时记入知识库」在优化中支持。

### 3. 小结

- **日历/待办如何影响数据库**：只有在你做「同步」时，才会从 Apple 拉取数据并写入数据库（实体 + Obsidian + 审核队列）。  
- **Agent 创建**：目前只影响 Apple 端；若开启「写入知识库」，则会在本系统多一条对应实体。

---

## 二、已实现与计划优化点

### 已实现

- 同步支持**数量上限**和**由新到旧/由旧到新**排序。
- Agent 使用 **get_current_datetime** 避免「今天」被算成错误年份。
- Agent 创建失败时返回 **error**，并提示用户先调用 get_current_datetime。

### 已实现（本次优化）

1. **首次/选择性同步**
   - **备忘录**：`GET /sync/apple/note-folders` 列出文件夹；同步时传 `folder_whitelist`（逗号分隔）只导入所选文件夹，不传则全部。
   - **日历**：同步时传 `days_back`、`days_forward`（默认 30/90 天），只导入该时间范围内的事件。
   - **待办**：`GET /sync/apple/reminder-lists` 列出列表；同步时传 `list_names` 只导入所选列表，`due_after`/`due_before`（ISO 日期）过滤截止范围。

2. **数据摄入页 UI**
   - 可折叠「日历/待办如何进入数据库？」说明同步与 Agent 创建的数据流。
   - 「同步范围（可选）」展开后：备忘录勾选文件夹、日历设置过去/未来天数、待办勾选列表 + 可选截止日期范围。

3. **Agent 与知识库联动**
   - `create_apple_note` / `create_apple_reminder` / `create_apple_event` 增加参数 `add_to_knowledge_base`（默认 true）：在 Apple 创建成功后，同时在本系统创建一条实体（source=agent_apple_notes / agent_apple_reminders / agent_apple_calendar），便于在实体管理、搜索中看到并打标签。

### 后续可做

- Agent 读取：`fetch_apple_data` 为日历/待办增加日期过滤参数（如只查「明天」的待办）。
- 定时同步时沿用用户上次选择的文件夹/列表/范围（持久化到 user_config 或前端 localStorage）。

---

## 三、与苹果三件套、已有数据的交互关系（简图）

```
[ 苹果 备忘录 / 待办 / 日历 ]
         │
         │ 用户点击「同步」或定时同步（可选范围：文件夹 / 时间范围 / 列表）
         ▼
[ 第二大脑后端 ]
         │
         ├─► SQLite 实体 (entities)  ← 已有数据库
         ├─► Obsidian .md 笔记
         └─► 审核队列 (LLM 建议标签) ─► 用户审核 ─► 标签回写实体 + Obsidian

[ 用户通过 Agent 说「创建明天 9 点日历」]
         │
         ▼
[ create_apple_event ] ─► 仅写 Apple 日历（当前）
                         ─► 可选：同时写一条实体到第二大脑（优化）
```

上述文档会随实现进度更新；具体 API 与前端交互以代码为准。
