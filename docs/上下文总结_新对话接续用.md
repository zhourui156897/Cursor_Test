# 第二大脑 — 全上下文总结（新对话接续用）

供在新对话中继续完善系统时快速恢复上下文。涵盖：项目是什么、已做/未做/需优化、关键文件、约定。

---

## 一、项目全貌

- **定位**：本地优先的「第二大脑 - 人生价值系统」。以 Obsidian 为中枢，Milvus 向量检索，Neo4j 知识图谱，Web Dashboard + Obsidian 插件双入口；支持 Apple 备忘录/待办/日历同步与 Agent 读写。
- **技术栈**：后端 Python 3.11+ / FastAPI；前端 React + TypeScript + Vite + Tailwind；向量库 Milvus-Lite/Standalone；图库 Neo4j；元数据 SQLite（`~/.dierdanao/data/dierdanao.db`）；LLM 通过 `user_config.yaml` 配置（含 OpenAI 等）。
- **数据流概要**：文件上传 / Apple 同步 → 解析 → 实体入 SQLite → LLM 建议标签 → 审核队列 → 审核通过后写 Obsidian frontmatter、按文件夹移动笔记、向量入 Milvus、关系入 Neo4j。Agent 可读 Apple、写 Apple（并可选择写入知识库实体）。
- **关键目录**：`backend/app/`（api、chat、services、storage、sync）、`frontend/src/`（api、pages、components）、`obsidian-plugin/`、`docs/`。配置：`.env`、`backend/config/user_config.yaml`（不提交 Git）。

---

## 二、已做的（含本轮完成）

### 2.1 历史已实现（功能清单「一、已实现功能总览」）

- 仪表盘、数据摄入（文件上传 + Apple 同步 + 同步范围可选 + 新建 Apple 项）、审核队列（筛选、手动标签、批量通过、通过后写 Obsidian 并移动笔记）、语义搜索、知识图谱、智能对话（RAG + Agent，含 Apple 读写与知识库工具）、实体管理、标签管理、用户管理、设置、Obsidian 插件。
- 多格式解析：文本/Word/Excel/PDF、图片(Vision)、音频(Whisper)、**视频(ffmpeg 抽音轨 + Whisper)**。
- Agent 工具：search_knowledge、list_entities、get_entity_detail、query_graph、list_tags、create_entity、update_entity_tags、summarize_content、get_statistics、get_current_datetime、fetch_apple_data、create_apple_note/reminder/event；创建 Apple 项后可选择写入知识库。
- 同步范围：备忘录文件夹白名单、日历 days_back/days_forward、待办 list_names + due_after/due_before；API：`GET /sync/apple/note-folders`、`GET /sync/apple/reminder-lists`。

### 2.2 本轮计划内已完成（对应计划执行记录）

| 阶段 | 项 | 关键改动 |
|------|---|----------|
| **Phase 1** | 1.1 语义搜索错误与空状态 | 后端 `api/search.py` 向量失败时返回 `message`；前端 Search 页展示该提示及空状态 |
| | 1.2 同步/创建失败提示 | `app/sync/messages.py` 统一 JXA 文案；`api/sync.py` 与 `chat/agent_tools.py` 在 JXA 失败时返回该文案（503/工具 error） |
| | 1.3 知识图谱空状态 | 前端 GraphView 请求失败时设 error、展示 stats.error 或接口错误信息 |
| | 1.4 Embedding 维度说明 | 《使用说明》增加「六、Embedding 与 Milvus 维度」 |
| **Phase 2** | 2.1 定时同步 + 范围持久化 | `app/sync/scheduler.py`；`api/sync.py` 中 trigger 成功后把本次参数写入 `apple_sync.sync_scope`；`main.py` lifespan 中按 `auto_sync`+`interval_minutes` 启动 APScheduler |
| | 2.2 Agent 按日期过滤 | `fetch_apple_data` 工具增加 days_back/days_forward、due_after/due_before；系统提示说明先 get_current_datetime 再传日期 |
| | 2.3 视频转文字 | `file_processor.py` 中 `_extract_video_via_whisper`：ffmpeg 抽音轨 → Whisper；需本机 ffmpeg |
| **Phase 5** | 5.1 完整安装包 | `backend/requirements.txt`；`docs/在另一台Mac上完整安装.md`；《使用说明》「七、维护与安装包同步」约定依赖变更时同步更新 requirements 与安装文档 |

### 2.3 v0.5.0 向量数据库全链路优化

| 项 | 关键改动 |
|---|----------|
| 向量化链路修复 | `review_service.py` 审核后 embed/extract 分开 try/except，失败升级为 error 级日志，返回 `embed_status` 字段给前端 |
| 补录历史数据 | `embedding_service.py` 新增 `re_embed_all_pending()`，查 `review_status='reviewed' AND milvus_id IS NULL` 逐个补录 |
| 重新向量化 API | `settings_api.py` 新增 `POST /settings/re-vectorize`，管理员权限；前端设置→系统信息 tab 增加「重新向量化」按钮 |
| Milvus schema v2 | `milvus_client.py` 新增 `folder_tags` / `content_tags` VARCHAR 字段；旧集合无数据时自动 drop+recreate |
| 向量化携带标签 | `embed_entity()` 写入 Milvus 时联查 entity_tags/tag_tree/content_tags，将标签名列表写入向量库 |
| 向量搜索支持筛选 | `semantic_search()` 新增 `folder_filter` / `tag_filter` 参数；搜索 API 增加 `folder` / `tag` 查询参数 |
| Agent 向量检索增强 | `search_knowledge` 工具新增 `folder_tag` / `content_tag` 参数；Agent 系统提示强调优先使用语义检索 |

### 2.4 其他已做（与体验/稳定性相关）

- **数据目录可写**：`sqlite_client.ensure_data_dir_writable()` 启动时检查，不可写则报错退出；《使用说明》「五、最佳实践」。
- **智能对话 500/503**：聊天接口不再在只读库时静默降级；只读时返回 503 并提示 chmod；RAG/Agent 执行异常时返回 500 且 detail 含具体原因。
- **审核通过后笔记移动**：`obsidian_writer.move_note_to_folder()`，审核通过时先移动文件再更新 frontmatter 与 DB obsidian_path。

---

## 三、未做的（计划内 + 功能清单）

- **Phase 3**：3.1 侧边栏与页面整合（需你定合并方案）、3.2 智能对话/侧边栏 UI 升级（需风格或参考）、3.3 语义搜索/知识图谱页统一感（空状态样式统一）。
- **Phase 4**：4.1 前端标签与 Obsidian 标签双向对齐（需方案：读 Obsidian 标签→前端、前端改标签→Obsidian、冲突与时机）；4.2 Embedding 维度校验增强（设置页保存或启动时校验与 Milvus 集合维度一致并提示）。
- **功能清单「二、未实现或待优化」** 中部分已在本轮完成（定时同步、Agent 按日期、语义搜索/图谱空状态与错误提示、同步失败提示、多模态视频），若文档尚未逐条更新，以本文「二、已做的」为准。

---

## 四、需优化的（待优化 + 已知问题）

- ~~**向量化链路**：审核通过后向量化静默失败~~ → v0.5.0 已修复（错误上报 + 补录机制 + 重新向量化按钮）
- ~~**向量库无标签筛选**~~ → v0.5.0 已修复（Milvus schema v2 含 folder_tags/content_tags，搜索 + Agent 支持筛选）
- ~~**Agent 不从向量库调取**~~ → v0.5.0 已修复（向量数据补录后 search_knowledge 正常走 Milvus）
- **语义搜索**：Milvus 不可用时已有后端 message 与前端展示；可再做强：无结果时的区分文案、或降级说明更细化。
- **知识图谱**：数据少时图较空；Neo4j/LLM 不可用时已有提示；可统一空状态组件样式（与 3.3 一起）。
- **同步/创建失败**：JXA 文案已统一；可考虑在前端「数据摄入」或 Agent 回复中更突出展示（如单独提示框）。
- **侧边栏与页面整合**：减少层级、合并入口，依赖 3.1 方案。
- **Embedding 维度**：已有文档说明；4.2 为在保存/启动时做校验。
- **FastAPI 弃用**：`api/sync.py` 中 `regex` 已弃用，建议改为 `pattern`。
- **功能清单**：建议将「二、未实现或待优化」中已实现项改为「已实现」并略写说明，避免与新对话认知不一致。

---

## 五、关键文件索引（便于新对话跳转）

| 用途 | 路径 |
|------|------|
| 计划执行进度 | `docs/计划执行记录.md` |
| 计划阶段与顺序 | `docs/待办计划.md` |
| 功能清单与待办 | `docs/功能清单与待办.md` |
| 数据流与优化说明 | `docs/数据流与优化说明.md` |
| 使用说明（关停/保存/启动/权限/维度/安装包同步） | `使用说明.md` |
| 另一台 Mac 完整安装 | `docs/在另一台Mac上完整安装.md` |
| 项目规则与目录 | `.cursor/rules/dierdanao-project.mdc` |
| 后端入口与定时同步 | `backend/app/main.py` |
| 聊天 API、只读/500 处理 | `backend/app/api/chat.py` |
| 搜索 API、向量失败 message | `backend/app/api/search.py` |
| 同步 API、JXA 文案、范围持久化 | `backend/app/api/sync.py` |
| Agent 工具与 Apple 日期参数 | `backend/app/chat/agent_tools.py`、`agent_runner.py` |
| 定时任务 | `backend/app/sync/scheduler.py` |
| JXA 统一文案 | `backend/app/sync/messages.py` |
| 视频转文字 | `backend/app/services/file_processor.py` |
| 数据目录可写检查 | `backend/app/storage/sqlite_client.py` |
| 后端依赖锁定 | `backend/requirements.txt` |
| Make 启动/停止/安装 | `Makefile` |

---

## 六、约定与维护

- **安装包同步**：后端依赖变更后，在 backend venv 中执行 `pip freeze --exclude-editable > requirements.txt` 并整理后提交；前端保持 `package-lock.json`，另一台用 `npm ci`；安装步骤或环境变更时更新 `docs/在另一台Mac上完整安装.md`。详见《使用说明》「七、维护与安装包同步」。
- **数据目录**：默认 `~/.dierdanao/data`，须可写；启动时会检查，否则报错并提示 chmod。
- **回复语言**：始终用中文与用户沟通；代码注释与 API 文案以中文为主。

---

以上为当前全部上下文的结构化总结；新对话中可据此继续完善第二大脑（未做项、需优化项、或新需求）。
