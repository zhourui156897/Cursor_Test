# 第二大脑 — 待办整体计划

本文档对《功能清单与待办》中的「未实现 / 计划中 / 待优化」项做阶段划分与执行顺序建议，便于按阶段推进。

---

## 一、阶段总览

| 阶段 | 主题 | 目标 | 预估工作量 |
|------|------|------|------------|
| **Phase 1** | 体验修复 | 错误可感知、提示明确，减少「无反应/报错不明」 | 小 |
| **Phase 2** | 能力增强 | 定时同步、Agent 按日期读、多模态扩展 | 小～中 |
| **Phase 3** | 体验升级 | 语义搜索/图谱空状态、侧边栏整合、智能对话 UI | 中 |
| **Phase 4** | 扩展与对齐 | 标签双向对齐、Embedding 维度校验与文档 | 中～大 |
| **Phase 5** | 交付与安装 | 完整安装包：依赖版本锁定 + 另一台 Mac 可复现安装文档与脚本 | 小～中 |

---

## 二、Phase 1 — 体验修复（优先）

**原则**：不增加新入口，只让现有功能在异常/空数据时有明确反馈。

| 序号 | 项 | 目标 | 范围 | 产出 |
|------|---|------|------|------|
| 1.1 | **语义搜索：错误与空状态** | 用户能区分「无结果」与「服务异常」 | 后端：Milvus 不可用/嵌入失败时返回明确 `message`；前端：空结果展示「暂无匹配」，报错展示接口返回的说明（可含「请检查 Milvus 与 Embedding 服务」） | 搜索页不再「无反应」或只显示 HTTP 500 |
| 1.2 | **同步/创建失败提示** | Apple JXA 失败时给出可操作说明 | 后端：JXA 执行失败时统一返回明确文案（如「请确保后端在本机 Mac 上运行」）；前端「数据摄入」、Agent 工具返回中展示该文案 | 用户知道是环境问题而非随便报错 |
| 1.3 | **知识图谱空状态** | Neo4j/LLM 不可用或图为空时有说明 | 后端：健康检查或图接口在不可用时返回明确状态；前端：图为空或服务不可用时展示「图服务暂不可用」或「暂无关系数据」 | 减少空白/困惑 |
| 1.4 | **Embedding 维度说明与校验** | 改模型后不再静默写入失败 | 文档（使用说明或设置页）注明「修改 embedding 模型须与 Milvus 集合维度一致」；可选：设置页保存 LLM 配置时或启动时校验维度并提示 | 降低配置错误率 |

**建议顺序**：1.1 → 1.2 → 1.3 → 1.4（彼此独立，可按需调换）。

---

## 三、Phase 2 — 能力增强

**原则**：在现有流程上增加「可配置、可调度」的能力，不重构大模块。

| 序号 | 项 | 目标 | 范围 | 产出 |
|------|---|------|------|------|
| 2.1 | **定时同步 + 范围持久化** | 用户选一次范围，之后按间隔自动拉取 | 将「同步范围」（文件夹、列表、日历/待办时间范围）持久化到配置或 DB；增加简单定时任务（如 APScheduler）按间隔调用现有同步 API；设置页可配置「是否开启定时同步」与间隔 | 无需每次手动选范围、点同步 |
| 2.2 | **Agent 按日期过滤读取** | 自然语言问「明天待办」「某日日历」能精确查 | `fetch_apple_data` 增加可选参数：日历 `date`/`days_back`/`days_forward`，待办 `due_after`/`due_before`；工具描述中写明用法；Agent 系统提示中引导在涉及日期时传参 | 「明天早上有什么」类问题更准确 |
| 2.3 | **多模态扩展（如视频）** | 支持一种视频输入并进入知识库 | 选定一种格式（如 mp4），流程：抽音频 → Whisper 转文字 → 与现有实体/审核流程对接；可选：元数据中记录「来自视频」 | 文档中标注「支持视频转文字」 |

**依赖**：2.1 依赖现有同步 API 与范围参数；2.2 依赖现有 `fetch_apple_data`；2.3 依赖现有解析与审核流水线。

**建议顺序**：2.2（小）→ 2.1（中）→ 2.3（中）。

---

## 四、Phase 3 — 体验升级

**原则**：在信息架构与视觉上收拢入口、提升一致性；部分依赖你的偏好（如「炫酷」具体指什么）。

| 序号 | 项 | 目标 | 范围 | 产出 |
|------|---|------|------|------|
| 3.1 | **侧边栏与页面整合** | 减少层级、合并重复入口 | 根据你指定的「哪些合并」（如：数据摄入与审核是否同栏、设置是否收拢），调整主导航与子路由；可能涉及路由与菜单配置 | 导航更短、更清晰 |
| 3.2 | **智能对话 / 侧边栏 UI 升级** | 更符合「炫酷科技感」与整合预期 | 需要先定风格或参考（配色、卡片/气泡、动效程度）；在现有 RAG/Agent 能力不变前提下，改 Chat 页与侧边栏的布局、字体、间距、空状态 | 对话区与侧栏视觉统一、更易用 |
| 3.3 | **语义搜索 / 知识图谱页统一感** | 搜索与图谱在空/错状态下风格一致 | 与 1.1、1.3 的文案配合，统一两页的空状态与错误状态组件样式（与 3.2 的视觉可同批考虑） | 列表/图/搜索体验一致 |

**依赖**：3.1 需你拍板合并方案；3.2 需风格或参考图；3.3 可与 Phase 1 的文案一起做，再统一样式。

**建议顺序**：先定 3.1 的整合方案 → 3.2 风格 → 再做 3.3 与 1.1/1.3 的样式统一。

---

## 五、Phase 4 — 扩展与对齐

**原则**：涉及多端/多数据源一致性的功能，需要明确规则与边界。

| 序号 | 项 | 目标 | 范围 | 产出 |
|------|---|------|------|------|
| 4.1 | **前端标签与 Obsidian 标签双向对齐** | 标签在两端一致且可互相驱动 | 设计：从 Obsidian 读取标签（如 frontmatter tags）写回前端标签体系；前端增删改标签时写回 Obsidian；冲突策略与同步时机（实时/按需/定时） | 文档与实现方案；可先做「读 Obsidian → 前端」再做「前端 → Obsidian」 |
| 4.2 | **Embedding 维度校验增强** | 配置错误在启动或保存时即发现 | 若 Phase 1 仅做了文档，此处可加：启动时或设置页保存时检查当前 embedding 维度与 Milvus 集合是否一致，不一致时阻止写入或明确提示 | 避免写入失败后才排查 |

**依赖**：4.1 依赖 Obsidian 插件或本地文件访问方式、以及现有标签树/内容标签模型；4.2 依赖 Milvus 与配置读取。

**建议顺序**：4.2 可与 1.4 合并或紧跟 1.4；4.1 单独排期，先出方案再实现。

---

## 六、Phase 5 — 交付与安装

**原则**：另一台 Mac 拿到仓库后能按文档与锁定版本完整安装、跑起第二大脑。

| 序号 | 项 | 目标 | 范围 | 产出 |
|------|---|------|------|------|
| 5.1 | **完整安装包** | 版本锁定 + 可复现安装 | 后端：提供 `requirements.txt`（或锁定 pyproject 依赖版本），并注明 Python 版本；前端：保留 `package-lock.json`，安装说明使用 `npm ci`；文档：新增《在另一台 Mac 上完整安装》步骤（环境要求、.env 示例、初始化 DB、启动方式）；可选：一键安装脚本 `make setup` 或 `scripts/install.sh` | 另一台 Mac 按文档可完整安装并运行 |

**依赖**：无；可与任意阶段并行或放在最后交付前做。

---

## 七、依赖与建议执行顺序（汇总）

```
Phase 1（可并行或短间隔）
  1.1 语义搜索错误与空状态
  1.2 同步/创建失败提示
  1.3 知识图谱空状态
  1.4 Embedding 维度说明（+ 可选校验）

Phase 2（在 1 之后）
  2.2 Agent 按日期过滤  →  2.1 定时同步+范围持久化  →  2.3 多模态（视频）

Phase 3（需你先定整合方案与风格）
  3.1 侧边栏整合  →  3.2 智能对话 UI 升级  →  3.3 搜索/图谱页统一感

Phase 4（独立排期）
  4.2 Embedding 校验增强（可与 1.4 合并）
  4.1 标签双向对齐（先方案后实现）

Phase 5（交付前或与其它并行）
  5.1 完整安装包（版本锁定 + 另一台 Mac 安装文档与脚本）
```

**首次落地建议**：先完成 Phase 1 全部（1.1～1.4），再选 Phase 2 中你最在意的 1～2 项（推荐 2.2 + 2.1），最后根据时间决定 Phase 3/4 的节奏。

---

## 八、与《功能清单与待办》的对应

| 功能清单中的项 | 本计划中的位置 |
|----------------|----------------|
| 语义搜索无反应 / 错误与空状态 | Phase 1.1 |
| 同步/创建失败提示 | Phase 1.2 |
| 知识图谱（可用性/空状态） | Phase 1.3 |
| Embedding 维度 | Phase 1.4 / 4.2 |
| 定时同步 + 范围持久化 | Phase 2.1 |
| Agent 按日期过滤读取 | Phase 2.2 |
| 多模态完善（如视频） | Phase 2.3 |
| 侧边栏与页面整合 | Phase 3.1 |
| 智能对话/侧边栏 UI 升级 | Phase 3.2 |
| 语义搜索/图谱页统一感 | Phase 3.3 |
| 前端标签与 Obsidian 双向对齐 | Phase 4.1 |
| 完整安装包（另一台 Mac 可复现安装） | Phase 5.1 |

以上为当前整体计划；执行时以《功能清单与待办》为功能边界，以本文档为阶段与顺序参考。
