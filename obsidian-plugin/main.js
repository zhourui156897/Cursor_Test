var R=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var F=(e,s)=>{for(var t in s)R(e,t,{get:s[t],enumerable:!0})},Y=(e,s,t,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of H(s))!G.call(e,i)&&i!==t&&R(e,i,{get:()=>s[i],enumerable:!(n=W(s,i))||n.enumerable});return e};var z=e=>Y(R({},"__esModule",{value:!0}),e);var K={};F(K,{default:()=>P});module.exports=z(K);var f=require("obsidian");var d=require("obsidian");var I=require("obsidian"),$={apiUrl:"http://localhost:8000",token:"",username:"admin",password:"changeme",syncOnStartup:!0,syncIntervalMinutes:30},v={...$};function V(e){v=e}function U(){return v.apiUrl.replace(/\/+$/,"")}async function J(e,s){return(await(0,I.requestUrl)({url:`${U()}${e}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json}async function O(){if(v.token)return v.token;let e=await J("/api/auth/login",{username:v.username,password:v.password});return v.token=e.access_token,v.token}async function D(e,s,t){let n=await O(),i={url:`${U()}${s}`,method:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}};t!==void 0&&(i.body=JSON.stringify(t));let p=await(0,I.requestUrl)(i);if(p.status===401){v.token="";let a=await O();return i.headers={...i.headers,Authorization:`Bearer ${a}`},(await(0,I.requestUrl)(i)).json}return p.json}var g={get:e=>D("GET",e),post:(e,s)=>D("POST",e,s),put:(e,s)=>D("PUT",e,s),del:e=>D("DELETE",e)},w={listPending:(e=1)=>g.get(`/api/review/pending?page=${e}`),getCount:()=>g.get("/api/review/count"),approve:(e,s)=>g.post(`/api/review/${e}/approve`,{modifications:s||null}),reject:(e,s="")=>g.post(`/api/review/${e}/reject`,{reason:s})},q={search:(e,s=10,t="hybrid")=>g.get(`/api/search?q=${encodeURIComponent(e)}&top_k=${s}&mode=${t}`)},j={send:(e,s,t="rag")=>g.post("/api/chat/send",{message:e,conversation_id:s,mode:t}),listConversations:(e=50)=>g.get(`/api/chat/conversations?limit=${e}`),getMessages:e=>g.get(`/api/chat/conversations/${e}/messages`),createConversation:(e="")=>g.post("/api/chat/conversations",{title:e}),deleteConversation:e=>g.del(`/api/chat/conversations/${e}`)};var _={check:()=>g.get("/health")};var C=class extends d.PluginSettingTab{constructor(s,t){super(s,t),this.plugin=t}display(){let{containerEl:s}=this;s.empty(),s.createEl("h2",{text:"\u7B2C\u4E8C\u5927\u8111 - \u8FDE\u63A5\u8BBE\u7F6E"}),new d.Setting(s).setName("\u540E\u7AEF API \u5730\u5740").setDesc("\u7B2C\u4E8C\u5927\u8111\u540E\u7AEF\u670D\u52A1\u5730\u5740").addText(t=>t.setPlaceholder("http://localhost:8000").setValue(this.plugin.settings.apiUrl).onChange(async n=>{this.plugin.settings.apiUrl=n,await this.plugin.saveSettings()})),new d.Setting(s).setName("\u7528\u6237\u540D").setDesc("\u767B\u5F55\u540E\u7AEF\u7684\u7528\u6237\u540D").addText(t=>t.setValue(this.plugin.settings.username).onChange(async n=>{this.plugin.settings.username=n,this.plugin.settings.token="",await this.plugin.saveSettings()})),new d.Setting(s).setName("\u5BC6\u7801").setDesc("\u767B\u5F55\u540E\u7AEF\u7684\u5BC6\u7801").addText(t=>{t.inputEl.type="password",t.setValue(this.plugin.settings.password).onChange(async n=>{this.plugin.settings.password=n,this.plugin.settings.token="",await this.plugin.saveSettings()})}),new d.Setting(s).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u9A8C\u8BC1\u540E\u7AEF\u8FDE\u63A5\u662F\u5426\u6B63\u5E38").addButton(t=>t.setButtonText("\u6D4B\u8BD5").onClick(async()=>{try{let n=await _.check();new d.Notice(`\u8FDE\u63A5\u6210\u529F! \u540E\u7AEF\u7248\u672C: ${n.version}`)}catch(n){new d.Notice(`\u8FDE\u63A5\u5931\u8D25: ${n}`)}})),s.createEl("h3",{text:"\u540C\u6B65\u8BBE\u7F6E"}),new d.Setting(s).setName("\u542F\u52A8\u65F6\u540C\u6B65").setDesc("Obsidian \u542F\u52A8\u65F6\u81EA\u52A8\u4ECE\u540E\u7AEF\u540C\u6B65\u6570\u636E").addToggle(t=>t.setValue(this.plugin.settings.syncOnStartup).onChange(async n=>{this.plugin.settings.syncOnStartup=n,await this.plugin.saveSettings()})),new d.Setting(s).setName("\u540C\u6B65\u95F4\u9694\uFF08\u5206\u949F\uFF09").setDesc("\u81EA\u52A8\u540C\u6B65\u95F4\u9694\uFF0C0 \u8868\u793A\u4E0D\u81EA\u52A8\u540C\u6B65").addText(t=>t.setValue(String(this.plugin.settings.syncIntervalMinutes)).onChange(async n=>{this.plugin.settings.syncIntervalMinutes=parseInt(n)||0,await this.plugin.saveSettings()}))}};var m=require("obsidian");var x="dierdanao-review",A=class extends m.ItemView{constructor(t){super(t);this.items=[];this.loading=!1}getViewType(){return x}getDisplayText(){return"\u5BA1\u6838\u961F\u5217"}getIcon(){return"clipboard-check"}async onOpen(){await this.refresh()}async refresh(){this.loading=!0,this.render();try{this.items=await w.listPending()}catch(t){new m.Notice(`\u52A0\u8F7D\u5BA1\u6838\u961F\u5217\u5931\u8D25: ${t}`),this.items=[]}this.loading=!1,this.render()}render(){let t=this.containerEl.children[1];t.empty();let n=t.createDiv({cls:"nav-header"});n.createEl("h4",{text:`\u5BA1\u6838\u961F\u5217 (${this.items.length})`,cls:"nav-header-title"});let i=n.createEl("button",{cls:"clickable-icon nav-action-button",attr:{"aria-label":"\u5237\u65B0"}});if((0,m.setIcon)(i,"refresh-cw"),i.addEventListener("click",()=>this.refresh()),this.loading){t.createEl("p",{text:"\u52A0\u8F7D\u4E2D...",cls:"pane-empty"});return}if(this.items.length===0){t.createEl("p",{text:"\u6CA1\u6709\u5F85\u5BA1\u6838\u7684\u9879\u76EE",cls:"pane-empty"});return}let p=t.createDiv({cls:"dierdanao-review-list"});for(let a of this.items){let l=p.createDiv({cls:"dierdanao-review-card"});l.createEl("div",{text:a.entity_title||"\u65E0\u6807\u9898",cls:"dierdanao-review-title"});let c=l.createDiv({cls:"dierdanao-review-meta"});c.createEl("span",{text:a.entity_source||"unknown",cls:"dierdanao-review-source"}),a.created_at&&c.createEl("span",{text:new Date(a.created_at).toLocaleDateString(),cls:"dierdanao-review-date"}),a.entity_content&&l.createEl("div",{text:a.entity_content.slice(0,120)+(a.entity_content.length>120?"...":""),cls:"dierdanao-review-content"});let o=l.createDiv({cls:"dierdanao-review-tags"});if(a.suggested_folder_tags?.length){o.createEl("span",{text:"\u6587\u4EF6\u5939: ",cls:"dierdanao-tag-label"});for(let r of a.suggested_folder_tags)o.createEl("span",{text:r,cls:"dierdanao-tag folder"})}if(a.suggested_content_tags?.length){o.createEl("span",{text:"\u6807\u7B7E: ",cls:"dierdanao-tag-label"});for(let r of a.suggested_content_tags)o.createEl("span",{text:r,cls:"dierdanao-tag content"})}let h=l.createDiv({cls:"dierdanao-review-actions"});h.createEl("button",{text:"\u901A\u8FC7",cls:"dierdanao-btn approve"}).addEventListener("click",async()=>{try{await w.approve(a.id),new m.Notice(`\u5DF2\u901A\u8FC7: ${a.entity_title}`),this.items=this.items.filter(r=>r.id!==a.id),this.render()}catch(r){new m.Notice(`\u5BA1\u6838\u5931\u8D25: ${r}`)}}),h.createEl("button",{text:"\u62D2\u7EDD",cls:"dierdanao-btn reject"}).addEventListener("click",async()=>{try{await w.reject(a.id,"\u4ECE Obsidian \u62D2\u7EDD"),new m.Notice(`\u5DF2\u62D2\u7EDD: ${a.entity_title}`),this.items=this.items.filter(r=>r.id!==a.id),this.render()}catch(r){new m.Notice(`\u62D2\u7EDD\u5931\u8D25: ${r}`)}})}}};var T=require("obsidian");var k="dierdanao-chat",B=class extends T.ItemView{constructor(t){super(t);this.messages=[];this.conversationId=null;this.mode="rag";this.loading=!1}getViewType(){return k}getDisplayText(){return"\u667A\u80FD\u5BF9\u8BDD"}getIcon(){return"message-square"}async onOpen(){this.render()}render(){let t=this.containerEl.children[1];t.empty(),t.addClass("dierdanao-chat-container");let n=t.createDiv({cls:"dierdanao-chat-header"});n.createEl("h4",{text:"\u667A\u80FD\u5BF9\u8BDD"});let i=n.createDiv({cls:"dierdanao-chat-mode"});i.createEl("button",{text:"RAG",cls:`dierdanao-mode-btn ${this.mode==="rag"?"active":""}`}).addEventListener("click",()=>{this.mode="rag",this.render()}),i.createEl("button",{text:"Agent",cls:`dierdanao-mode-btn ${this.mode==="agent"?"active":""}`}).addEventListener("click",()=>{this.mode="agent",this.render()});let l=n.createEl("button",{cls:"clickable-icon",attr:{"aria-label":"\u65B0\u5BF9\u8BDD"}});(0,T.setIcon)(l,"plus"),l.addEventListener("click",()=>{this.messages=[],this.conversationId=null,this.render()});let c=t.createDiv({cls:"dierdanao-chat-messages"});this.messages.length===0&&c.createDiv({cls:"dierdanao-chat-empty"}).createEl("p",{text:this.mode==="rag"?"\u57FA\u4E8E\u77E5\u8BC6\u5E93\u7684\u95EE\u7B54":"Agent \u53EF\u4EE5\u641C\u7D22\u3001\u521B\u5EFA\u3001\u6253\u6807\u7B7E"});for(let r of this.messages){let u=c.createDiv({cls:`dierdanao-chat-msg ${r.role}`});if(r.toolCalls?.length){let b=u.createDiv({cls:"dierdanao-chat-tools"});for(let S of r.toolCalls){let N=b.createDiv({cls:"dierdanao-tool-call"});(0,T.setIcon)(N.createSpan(),"wrench"),N.createSpan({text:` ${S.tool}`})}}if(u.createDiv({text:r.content,cls:"dierdanao-chat-text"}),r.sources?.length){let b=u.createDiv({cls:"dierdanao-chat-sources"});b.createEl("small",{text:"\u5F15\u7528:"});for(let S of r.sources)b.createEl("small",{text:` [${S.index}] ${S.title}`,cls:"dierdanao-source-ref"})}}this.loading&&c.createDiv({text:this.mode==="agent"?"Agent \u601D\u8003\u4E2D...":"\u68C0\u7D22\u4E2D...",cls:"dierdanao-chat-loading"}),c.scrollTop=c.scrollHeight;let o=t.createDiv({cls:"dierdanao-chat-input"}),h=o.createEl("input",{type:"text",placeholder:this.mode==="agent"?"\u8BA9 Agent \u5E2E\u4F60...":"\u5411\u77E5\u8BC6\u5E93\u63D0\u95EE...",cls:"dierdanao-chat-input-field"}),y=o.createEl("button",{cls:"dierdanao-chat-send"});(0,T.setIcon)(y,"send");let E=async()=>{let r=h.value.trim();if(!(!r||this.loading)){h.value="",this.messages.push({role:"user",content:r}),this.loading=!0,this.render();try{let u=await j.send(r,this.conversationId||void 0,this.mode);this.conversationId=u.conversation_id,this.messages.push({role:"assistant",content:u.answer,sources:u.sources,toolCalls:u.tool_calls})}catch(u){this.messages.push({role:"assistant",content:`\u9519\u8BEF: ${u}`})}this.loading=!1,this.render()}};y.addEventListener("click",E),h.addEventListener("keydown",r=>{r.key==="Enter"&&E()})}};var M=require("obsidian");var L=class extends M.Modal{constructor(t){super(t);this.results=[];this.query="";this.searching=!1}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("dierdanao-search-modal"),t.createEl("h3",{text:"\u8BED\u4E49\u641C\u7D22"});let n=t.createDiv({cls:"dierdanao-search-form"}),i=n.createEl("input",{type:"text",placeholder:"\u8F93\u5165\u81EA\u7136\u8BED\u8A00\u67E5\u8BE2...",cls:"dierdanao-search-input"}),p=n.createEl("button",{text:"\u641C\u7D22",cls:"dierdanao-btn approve"}),a=t.createDiv({cls:"dierdanao-search-results"}),l=async()=>{if(this.query=i.value.trim(),!!this.query){this.searching=!0,a.empty(),a.createEl("p",{text:"\u641C\u7D22\u4E2D..."});try{let c=await q.search(this.query,10);if(this.results=c.results,a.empty(),this.results.length===0){a.createEl("p",{text:"\u672A\u627E\u5230\u76F8\u5173\u7ED3\u679C",cls:"pane-empty"});return}a.createEl("small",{text:`\u627E\u5230 ${c.total} \u6761\u7ED3\u679C`,cls:"dierdanao-search-count"});for(let o of this.results){let h=a.createDiv({cls:"dierdanao-search-result"}),y=h.createDiv({cls:"dierdanao-search-result-title"});y.createEl("strong",{text:o.title||"\u65E0\u6807\u9898"}),o.source&&y.createEl("span",{text:` [${o.source}]`,cls:"dierdanao-search-result-source"}),o.content&&h.createEl("div",{text:o.content.slice(0,200)+(o.content.length>200?"...":""),cls:"dierdanao-search-result-content"});let E=h.createDiv({cls:"dierdanao-search-result-meta"});E.createEl("span",{text:o.match_type}),o.distance!==null&&E.createEl("span",{text:`\u76F8\u4F3C\u5EA6: ${(1-o.distance).toFixed(3)}`})}}catch(c){a.empty(),a.createEl("p",{text:`\u641C\u7D22\u5931\u8D25: ${c}`})}this.searching=!1}};p.addEventListener("click",l),i.addEventListener("keydown",c=>{c.key==="Enter"&&l()}),i.focus()}onClose(){this.contentEl.empty()}};var P=class extends f.Plugin{constructor(){super(...arguments);this.settings={...$};this.statusBarItem=null;this.syncInterval=null}async onload(){await this.loadSettings(),V(this.settings),this.registerView(x,t=>new A(t)),this.registerView(k,t=>new B(t)),this.addSettingTab(new C(this.app,this)),this.addRibbonIcon("clipboard-check","\u5BA1\u6838\u961F\u5217",()=>{this.activateView(x)}),this.addRibbonIcon("message-square","\u667A\u80FD\u5BF9\u8BDD",()=>{this.activateView(k)}),this.addCommand({id:"open-review",name:"\u6253\u5F00\u5BA1\u6838\u961F\u5217",callback:()=>this.activateView(x)}),this.addCommand({id:"open-chat",name:"\u6253\u5F00\u667A\u80FD\u5BF9\u8BDD",callback:()=>this.activateView(k)}),this.addCommand({id:"semantic-search",name:"\u8BED\u4E49\u641C\u7D22",callback:()=>new L(this.app).open()}),this.addCommand({id:"check-connection",name:"\u68C0\u67E5\u540E\u7AEF\u8FDE\u63A5",callback:async()=>{try{let t=await _.check();new f.Notice(`\u540E\u7AEF\u5DF2\u8FDE\u63A5 (v${t.version})`)}catch(t){new f.Notice(`\u540E\u7AEF\u8FDE\u63A5\u5931\u8D25: ${t}`)}}}),this.addCommand({id:"refresh-review",name:"\u5237\u65B0\u5BA1\u6838\u961F\u5217",callback:async()=>{let t=this.app.workspace.getLeavesOfType(x);for(let n of t)n.view.refresh()}}),this.addCommand({id:"ask-about-selection",name:"\u95EE\u7B2C\u4E8C\u5927\u8111\uFF08\u57FA\u4E8E\u9009\u4E2D\u6587\u672C\uFF09",editorCallback:async t=>{if(!t.getSelection()){new f.Notice("\u8BF7\u5148\u9009\u4E2D\u4E00\u4E9B\u6587\u672C");return}await this.activateView(k),new f.Notice("\u5DF2\u6253\u5F00\u5BF9\u8BDD\u9762\u677F\uFF0C\u53EF\u57FA\u4E8E\u9009\u4E2D\u5185\u5BB9\u63D0\u95EE")}}),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar(),this.settings.syncOnStartup&&setTimeout(()=>this.checkBackendAndNotify(),3e3),this.registerInterval(window.setInterval(()=>this.updateStatusBar(),6e4))}onunload(){}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings),V(this.settings)}async activateView(t){let{workspace:n}=this.app,i=null,p=n.getLeavesOfType(t);p.length>0?i=p[0]:(i=n.getRightLeaf(!1),i&&await i.setViewState({type:t,active:!0})),i&&n.revealLeaf(i)}async updateStatusBar(){if(this.statusBarItem)try{let{count:t}=await w.getCount();this.statusBarItem.setText(t>0?`\u{1F9E0} \u5BA1\u6838: ${t}`:"\u{1F9E0} \u7B2C\u4E8C\u5927\u8111")}catch{this.statusBarItem.setText("\u{1F9E0} \u79BB\u7EBF")}}async checkBackendAndNotify(){try{let t=await _.check(),{count:n}=await w.getCount();n>0&&new f.Notice(`\u7B2C\u4E8C\u5927\u8111\u5DF2\u8FDE\u63A5 (v${t.version})\uFF0C\u6709 ${n} \u6761\u5F85\u5BA1\u6838`)}catch{}}};
